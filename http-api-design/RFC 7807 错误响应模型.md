
RFC 7807 å®šä¹‰äº†ä¸€ç§**æ ‡å‡†åŒ–çš„ HTTP API é”™è¯¯å“åº”æ¨¡å‹**ï¼Œå¸¸è¢«ç§°ä¸º **Problem Details for HTTP APIs**ã€‚å®ƒçš„ç›®æ ‡æ˜¯ï¼š**è®©å®¢æˆ·ç«¯å¯ä»¥ç”¨ç»Ÿä¸€ã€æœºå™¨å¯è¯»çš„æ–¹å¼ç†è§£é”™è¯¯**ï¼Œè€Œä¸æ˜¯è§£æäº”èŠ±å…«é—¨çš„é”™è¯¯ JSONã€‚

ä¸‹é¢æˆ‘ä» **æ¦‚å¿µ â†’ å­—æ®µ â†’ ç¤ºä¾‹ â†’ è®¾è®¡å»ºè®®ï¼ˆç»“åˆä½ å¸¸åšçš„ Go / Gin / AppError ä½“ç³»ï¼‰** æ¥è¯´æ˜ã€‚

---

## ä¸€ã€RFC 7807 æ˜¯ä»€ä¹ˆï¼Ÿ

RFC 7807 è§„å®šäº†ä¸€ç§ **é”™è¯¯å“åº”çš„ JSON ç»“æ„**ï¼Œå¹¶å»ºè®®ä½¿ç”¨ï¼š

* **HTTP Content-Type**

  ```
  application/problem+json
  ```
* **HTTP çŠ¶æ€ç ** ä»ç„¶ä½¿ç”¨æ ‡å‡† HTTP statusï¼ˆ400 / 404 / 500 â€¦ï¼‰

å®ƒä¸å–ä»£ HTTP statusï¼Œè€Œæ˜¯**è¡¥å……æ›´ç»“æ„åŒ–çš„é”™è¯¯ä¿¡æ¯**ã€‚

---

## äºŒã€æ ‡å‡†å­—æ®µï¼ˆæ ¸å¿ƒï¼‰

RFC 7807 å®šä¹‰äº† 5 ä¸ªæ ‡å‡†å­—æ®µï¼ˆå…¶ä¸­ 2 ä¸ªæ˜¯å¼ºçƒˆæ¨èï¼‰ï¼š

| å­—æ®µ         | å¿…é€‰ | å«ä¹‰               |
| ---------- | -- | ---------------- |
| `type`     | æ¨è | é”™è¯¯ç±»å‹çš„ URIï¼ˆæœºå™¨å¯è¯†åˆ«ï¼‰ |
| `title`    | æ¨è | é”™è¯¯ç®€è¦è¯´æ˜ï¼ˆäººç±»å¯è¯»ï¼‰     |
| `status`   | å¯é€‰ | HTTP çŠ¶æ€ç          |
| `detail`   | å¯é€‰ | æ›´å…·ä½“çš„é”™è¯¯æè¿°         |
| `instance` | å¯é€‰ | æœ¬æ¬¡é”™è¯¯çš„å”¯ä¸€æ ‡è¯†ï¼ˆè¯·æ±‚å®ä¾‹ï¼‰  |

### ç¤ºä¾‹ï¼ˆå®˜æ–¹é£æ ¼ï¼‰

```json
{
  "type": "https://example.com/problems/invalid-parameter",
  "title": "Invalid request parameter",
  "status": 400,
  "detail": "The 'age' parameter must be a positive integer.",
  "instance": "/users/123"
}
```

---

## ä¸‰ã€å­—æ®µè¯­ä¹‰ç»†è®²ï¼ˆéå¸¸é‡è¦ï¼‰

### 1ï¸âƒ£ `type` â€”â€” **é”™è¯¯çš„â€œç§ç±»â€**

* æ˜¯ä¸€ä¸ª **URI**ï¼ˆé€šå¸¸æ˜¯ URLï¼‰
* **ä¸æ˜¯ä¸ºäº†è®©ç”¨æˆ·ç‚¹**ï¼Œè€Œæ˜¯ä¸ºäº†è®©ç¨‹åºè¯†åˆ«
* ç›¸åŒ `type` â‡’ ç›¸åŒè¯­ä¹‰

```text
type = https://api.myapp.com/problems/permission-denied
```

ğŸ‘‰ **è¿™æ˜¯ RFC 7807 æœ€æ ¸å¿ƒçš„è®¾è®¡ç‚¹**

---

### 2ï¸âƒ£ `title` â€”â€” **ç®€çŸ­ç¨³å®šçš„é”™è¯¯å**

* é¢å‘äººç±»
* **åº”è¯¥æ˜¯ç¨³å®šçš„**ï¼ˆä¸è¦åŒ…å«åŠ¨æ€ä¿¡æ¯ï¼‰

```json
"title": "Permission denied"
```

---

### 3ï¸âƒ£ `detail` â€”â€” **åŠ¨æ€é”™è¯¯ä¿¡æ¯**

* å¯å˜
* ç»™è°ƒè¯• / UI å±•ç¤ºç”¨
* å¯ä»¥åŒ…å«å‚æ•°ã€åŸå› ç­‰

```json
"detail": "User 123 has no access to resource 456"
```

---

### 4ï¸âƒ£ `instance` â€”â€” **æœ¬æ¬¡è¯·æ±‚çš„å®ä¾‹ ID**

* ç”¨äºæ’æŸ¥æ—¥å¿—
* å¯ä»¥æ˜¯ï¼š

  * è¯·æ±‚è·¯å¾„
  * trace-id
  * request-id

```json
"instance": "req-7f3c9d8a"
```

---

## å››ã€å…è®¸æ‰©å±•å­—æ®µï¼ˆéå¸¸å…³é”®ï¼‰

RFC 7807 **æ˜ç¡®å…è®¸è‡ªå®šä¹‰å­—æ®µ**ï¼š

> Problem Details objects MAY have additional members.

è¿™ç‚¹å¯¹ä½ ä¹‹å‰è®¾è®¡çš„ **AppError / ErrorCode / IO åˆ†ç±»** éå¸¸å‹å¥½ã€‚

### å¸¸è§æ‰©å±•å­—æ®µ

```json
{
  "type": "https://api.myapp.com/problems/db-error",
  "title": "Database error",
  "status": 500,
  "code": 1003,
  "category": "IO",
  "retryable": false,
  "traceId": "abc-123"
}
```

---

## äº”ã€åœ¨å®é™… API ä¸­çš„æ¨èåˆ†å±‚ï¼ˆå¾ˆé‡è¦ï¼‰

### 1ï¸âƒ£ HTTP Statusï¼š**ç²—ç²’åº¦**

* 400 / 401 / 403 / 404 / 409 / 500
* ç»™ä¸­é—´ä»¶ / ä»£ç† / CDN çœ‹

### 2ï¸âƒ£ `type`ï¼š**è¯­ä¹‰çº§é”™è¯¯**

* ç¨³å®š
* å¯æ–‡æ¡£åŒ–
* å¯ç”¨äºå®¢æˆ·ç«¯åˆ†æ”¯å¤„ç†

### 3ï¸âƒ£ `code`ï¼ˆè‡ªå®šä¹‰ï¼‰ï¼š**ä¸šåŠ¡/ç³»ç»Ÿé”™è¯¯ç **

* ä½ å·²æœ‰çš„ `1001 / 1002 / 1003`
* éå¸¸é€‚åˆä¿ç•™

---

## å…­ã€ç»“åˆä½  Go / Gin çš„ AppError è®¾è®¡ï¼ˆç¤ºä¾‹ï¼‰

### AppError â†’ RFC 7807 æ˜ å°„

```go
type ProblemDetail struct {
	Type     string `json:"type"`
	Title    string `json:"title"`
	Status   int    `json:"status,omitempty"`
	Detail   string `json:"detail,omitempty"`
	Instance string `json:"instance,omitempty"`

	Code     int    `json:"code,omitempty"`
	Category string `json:"category,omitempty"`
}
```

### Gin middleware ä¸­ç»Ÿä¸€è¾“å‡º

```go
func WriteProblem(c *gin.Context, err *AppError) {
	p := ProblemDetail{
		Type:     "https://api.xxx.com/problems/" + err.Name,
		Title:    err.Title,
		Status:   err.HTTPStatus,
		Detail:   err.Message,
		Code:     err.Code,
		Category: err.Category,
		Instance: c.Request.URL.Path,
	}

	c.Header("Content-Type", "application/problem+json")
	c.JSON(err.HTTPStatus, p)
}
```

---

## ä¸ƒã€å¸¸è§åæ¨¡å¼ï¼ˆâš ï¸ï¼‰

âŒ æŠŠæ‰€æœ‰é”™è¯¯éƒ½å¡è¿› `detail`
âŒ `type` æ¯æ¬¡å˜åŒ–ï¼ˆåŒ…å«å‚æ•°ï¼‰
âŒ ä¸ä½¿ç”¨ HTTP statusï¼Œåªé  code
âŒ `title` æ”¾åŠ¨æ€ä¿¡æ¯

---

## å…«ã€ä½ ä»€ä¹ˆæ—¶å€™åº”è¯¥ç”¨ RFC 7807ï¼Ÿ

âœ… å…¬å…± API
âœ… å‰åç«¯åˆ†ç¦»
âœ… å¤šå®¢æˆ·ç«¯ï¼ˆWeb / Mobile / Third-partyï¼‰
âœ… éœ€è¦ç¨³å®šé”™è¯¯å¥‘çº¦

âŒ å†…éƒ¨è„šæœ¬
âŒ å•ä½“åº”ç”¨å†…éƒ¨è°ƒç”¨

---

## ä¹ã€å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç»§ç»­å¸®ä½ 

* æŠŠä½ ä¹‹å‰çš„ **AppError é”™è¯¯ç ä½“ç³»å®Œæ•´æ˜ å°„åˆ° RFC 7807**
* è®¾è®¡ **error type URI å‘½åè§„èŒƒ**
* ç»™ä½ ä¸€å¥— **Gin middleware + recover + logging** çš„å®Œæ•´å®ç°
* å¯¹æ¯” **Google API error model vs RFC 7807**

ä½ æƒ³å¾€å“ªä¸€å—ç»§ç»­æ·±å…¥ï¼Ÿ
